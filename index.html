<!DOCTYPE html>
<html>
  <head>
    <title>KDAnalyzer</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script src="vars.js"></script>
    <script src="init.js"></script>
    <script src="file.js"></script>
    <script src="fetch.js"></script>
    <link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" />
    <style type="text/css">
    div#db_tbl_area {
        width: 700px;
    }
    div#profit_tbl_area {
        width: 900px;
        font-size: 14px;
    }
    canvas {
        width:980px !important;
        height:300px !important;
    }
    </style>
  </head>
  <body onload='init()'>
    <button onclick='save()' id='save_btn' disabled="disabled">儲存資料</button>
    <input type="file" id='load_btn' onchange="read_files(event)"></input>
    <hr>
    抓取時間區段為從現在往前推特定時間, 為了防止被 ban, 所以限定抓取速度, 以月為單位, 每 5s 抓一次
    <table>
        <tr>
            <td>
                股票代號：<input type='text' id='stock_id' value='' size='6'></input>
                <button onclick='get_stock_data()'>抓取歷史資料</button>
            </td>
            <td>
                <div id="fetch_region">
                <input type='checkbox' class='checkbox' value='30' checked/>一個月
                <input type='checkbox' class='checkbox' value='90'/>三個月
                <input type='checkbox' class='checkbox' value='180'/>六個月
                <input type='checkbox' class='checkbox' value='365'/>一年
                <input type='checkbox' class='checkbox' value='1095'/>三年
                <input type='checkbox' class='checkbox' value='1825'/>五年
                </div>
            </td>
        </tr>
    </table>
    <label id='loading'></label><br>
    <label id='req_url'></label>
    <hr>
    <label>平均天數若為 0, 會自動用 1~7 的平均天數來計算, 並自動挑獲利最大的平均天數</label><br>
    <button onclick='update_stocks()'>更新最新股票資料</button>
    <div id='db_tbl_area'>
        <table id='db_tbl' class='display' width='100%'></table>
    </div>
    <hr>
    <canvas id='stock_line_chart'></canvas>
    <hr>
    <div id='profit_tbl_area'>
        <label id='avg_profit'></label>
        <table id='profit_tbl' class='display' width='100%'></table>
    </div>
  </body>
  <script>
    var gen_db_tbl = function() {
        $('#db_tbl').DataTable().clear();

        var data_set = [];

        var count = 1;
        for (var stock_id in db) {
            var item = [];
            item.push(count++);
            item.push(stock_id);
            item.push(db[stock_id].name);
            item.push(db[stock_id].data.length);
            item.push('<input type="text" id="' + stock_id + '_days" size="3" value="0">日</input>');
            item.push('<button class="analyze">分析</button>');
            item.push('<button class="delete">刪除</button>');
            data_set.push(item);
        }

        $('#db_tbl').DataTable().clear();
        $('#db_tbl').DataTable().rows.add(data_set);
        $('#db_tbl').DataTable().draw();
    }

    var gen_profit_tbl = function(update) {
        $('#profit_tbl').DataTable().clear();
        $('#avg_profit').text('');
        if (profits.length == 0)
            return 0;

        var data_set = [];
        var count = 1;
        var avg_p = 0;
        for (var i=0 ; i<profits.length ; i++) {
            var item = [];
            item.push(count++);
            if (profits[i].end_date == '--') {
                item.push(profits[i].begin_date + ' - ');
                item.push(profits[i].begin_price.toFixed(2) + ' - ' + profits[i].end_price.toFixed(2));
                var kd = '(' + profits[i].begin_k9 + ',' + profits[i].begin_d9 + ')->'
                       + 'KD黃金交叉';
                item.push(kd);
            }
            else {
                item.push(profits[i].begin_date + ' - ' + profits[i].end_date);
                item.push(profits[i].begin_price.toFixed(2) + ' - ' + profits[i].end_price.toFixed(2));
                if (profits[i].end_k9 == 0 && profits[i].end_d9 == 0) {
                    var kd = '(' + profits[i].begin_k9 + ',' + profits[i].begin_d9 + ')->停損點 (-5%)';
                    item.push(kd);
                }
                else {
                    var kd = '(' + profits[i].begin_k9 + ',' + profits[i].begin_d9 + ')->'
                           + '(' + profits[i].end_k9 + ',' + profits[i].end_d9 + ')';
                    item.push(kd);
                }
            }
            var b_price = parseFloat(profits[i].begin_price);
            var e_price = parseFloat(profits[i].end_price);
            var p = ((e_price - b_price) / (b_price)) * 100;
            avg_p += p;
            item.push(p.toFixed(2) + '%');


            data_set.push(item);
        }

        avg_p = avg_p / profits.length;
        if (update == true) {
            $('#profit_tbl').DataTable().clear();
            $('#profit_tbl').DataTable().rows.add(data_set);
            $('#profit_tbl').DataTable().draw();
            $('#avg_profit').text('平均天數[' + best_days + '], 平均投資效益: ' + avg_p.toFixed(2) + '%');
        }
        return avg_p;
    }

    var refresh_line_chart = function(key, days, update) {
        if (!Array.prototype.last){
            Array.prototype.last = function() {
                return this[this.length - 1];
            }
        }

        var stock = db[key];

        var state = 'search_golden_cross';
        var price_title = stock.name + '(' + key + ')';
        var price_data = [];
        var price_labels = [];
        var k9_data = [];
        var d9_data = [];
        var prices = [];
        var max_price = -1;
        var min_price = 10000;
        var K9 = 0;
        var D9 = 0;
        var cache = [];
        var last_price = 0;
        var curr_profit = {};
        profits = [];
        for (var i=0 ; i<stock.data.length ; i++) {
            var today_price = 0;
            if (stock.data[i].price == undefined)
                today_price = last_price;
            else
                today_price = parseFloat(stock.data[i].price);

            last_price = today_price;
            if (i % days != 0) {
                cache.push(today_price);
                continue;
            }

            if (cache.length > 0) {
                var sum = 0;
                for (var j=0 ; j<cache.length ; j++) {
                    sum += cache[j];
                }
                today_price = sum / cache.length;
                // console.log('sum: ' + sum +', today: ' + today_price);
                cache = [];
            }

            price_labels.push(stock.data[i].date);
            price_data.push(stock.data[i].price);
            if (min_price > today_price) {
                min_price = today_price;
            }
            if (max_price < today_price) {
                max_price = today_price;
            }

            prices.push(today_price);
            //https://www.cmoney.tw/notes/note-detail.aspx?nid=16024
            if (prices.length == 9) {
                // console.log(prices);

                var min_price = 100000.0;
                var max_price = 0;
                for (var j=0 ; j<prices.length ; j++) {
                    if (min_price > prices[j])
                        min_price = prices[j];
                    if (max_price < prices[j])
                        max_price = prices[j];
                }

                var RSV = 0;
                if (max_price > min_price)
                    RSV = Math.round(((today_price - min_price) / (max_price - min_price)) * 100);

                K9 = Math.round(K9 * 0.667 + RSV * 0.333);
                D9 = Math.round(D9 * 0.667 + K9 * 0.333);
                // console.log('[' + stock.data[i].date + '] RSV: ' + RSV + ',K9: ' + K9 + ',D9: ' + D9 + ',k9.last(): ' + k9_data.last() + ',d9.last(): ' + d9_data.last());

                if (state == 'search_golden_cross') {
                    if ((k9_data.last() <= d9_data.last()) && (K9 > D9) && (K9 < 20)) {
                    // if ((k9_data.last() <= d9_data.last()) && (K9 > D9)) {
                        // console.log('黃金交叉');
                        curr_profit = {};
                        curr_profit.begin_date = stock.data[i].date;
                        curr_profit.begin_price = today_price;
                        curr_profit.begin_k9 = K9;
                        curr_profit.begin_d9 = D9;
                        curr_profit.end_date = '--';
                        state = 'search_dead_cross';
                    }
                }
                else if (state == 'search_dead_cross') {
                    // if ((k9_data.last() > d9_data.last()) && (K9 < D9) && (D9 - K9 > 2)) {
                    var p = (curr_profit.begin_price - today_price) / curr_profit.begin_price;
                    if (p > 0 && p > 0.05) {
                        // console.log('停損點(-5%)');
                        curr_profit.end_date = stock.data[i].date;
                        curr_profit.end_price = today_price;
                        curr_profit.end_k9 = 0;
                        curr_profit.end_d9 = 0;
                        profits.push(curr_profit);
                        state = 'search_golden_cross';
                    }
                    else if ((k9_data.last() >= d9_data.last()) && (K9 < D9)) {
                        // console.log('死亡交叉');
                        curr_profit.end_date = stock.data[i].date;
                        curr_profit.end_price = today_price;
                        curr_profit.end_k9 = K9;
                        curr_profit.end_d9 = D9;
                        profits.push(curr_profit);
                        state = 'search_golden_cross';
                    }
                }

                k9_data.push(K9);
                d9_data.push(D9);
                prices.shift();
            }
            else {
                k9_data.push(0);
                d9_data.push(0);
            }
        }

        if (curr_profit.end_date == '--') {
            // console.log('found a new golden');
            curr_profit.end_price = today_price;
            profits.push(curr_profit);
        }
        // console.log(profits);

        var avg_profit = gen_profit_tbl(update);

        if (update) {
            line_chart.data.labels = price_labels;
            line_chart.data.datasets[0].label = price_title;
            line_chart.data.datasets[0].data = price_data;
            line_chart.data.datasets[1].data = k9_data;
            line_chart.data.datasets[2].data = d9_data;

            line_chart.options.scales.yAxes[0].ticks.suggestedMin = min_price * 0.8;
            line_chart.options.scales.yAxes[0].ticks.suggestedMax = max_price * 1.05;
            line_chart.update();
        }

        return avg_profit;
    }

  </script>
</html>
